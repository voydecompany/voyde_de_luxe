<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Voyde de luxe</title>

<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#ffffff;
    --muted:#777;
    --accent:#000;
    --card:#fafafa;
    --glass: rgba(0,0,0,0.06);
    --topbar-height:64px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background:var(--bg);
    color:#111;
    -webkit-font-smoothing:antialiased;
    scroll-behavior:smooth;
  }

  /* LOADING SCREEN */
  #loader {
    position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#fff;z-index:9999;flex-direction:column;
  }
  .spinner{
    width:56px;height:56px;border-radius:50%;border:6px solid #eee;border-top-color:#111;animation:spin .9s linear infinite;margin-bottom:12px;
  }
  @keyframes spin{to{transform:rotate(360deg)}}
  .loader-text{color:#666;font-size:14px}

  /* TOPBAR (fixed) */
  .topbar{
    position:fixed;top:0;left:0;right:0;height:var(--topbar-height);background:#fff;border-bottom:1px solid #eee;display:flex;align-items:center;
    justify-content:space-between;padding:0 16px;z-index:60;
  }
  .top-left{display:flex;align-items:center;gap:12px}
  .hamburger{
    width:42px;height:42px;border-radius:8px;border:1px solid #eee;background:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer;
  }
  .brand{font-family:"Playfair Display",serif;font-size:18px;letter-spacing:1.6px;font-weight:700}
  .top-right{display:flex;align-items:center;gap:10px}
  .icon-btn{width:42px;height:42px;border-radius:8px;border:1px solid #eee;background:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer;position:relative}
  .cart-count{position:absolute;top:-6px;right:-6px;background:#e53935;color:#fff;border-radius:12px;padding:2px 6px;font-size:11px;font-weight:700}

  /* layout */
  .app {
    display:grid;
    grid-template-columns: 260px 1fr 360px; /* sidebar | main | cart */
    min-height:100vh;
    gap:24px;
    padding-top: calc(var(--topbar-height) + 20px); /* leave space under topbar */
  }

  /* SIDEBAR */
  .sidebar{
    padding:20px 18px;
    border-right:1px solid #eee;
    background:linear-gradient(180deg, rgba(255,255,255,0.95), rgba(250,250,250,0.95));
    height:calc(100vh - var(--topbar-height) - 20px);
    position:sticky;top:calc(var(--topbar-height) + 10px);
    overflow:auto;
  }
  .brand-side{
    font-family:"Playfair Display", serif;
    font-size:20px;
    letter-spacing:2px;
    font-weight:700;
    margin-bottom:12px;
  }
  .side-list{list-style:none;padding:0;margin:10px 0 0 0}
  .side-list li{margin:8px 0;}
  .side-list button{
    background:none;border:none;padding:10px 6px;text-align:left;width:100%;cursor:pointer;
    font-weight:600;color:var(--muted);font-size:14px;border-radius:6px;
  }
  .side-list button.active{color:var(--accent);background:var(--glass)}

  .filters{
    margin-top:20px;font-size:13px;color:var(--muted)
  }
  .filter-item{margin:8px 0;display:flex;justify-content:space-between;align-items:center}
  .small{font-size:12px;color:#999}

  /* MAIN */
  main{
    padding:10px 20px 40px 20px;
  }

  .hero{
    display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;gap:12px;
  }
  .hero-left{max-width:680px}
  h1{margin:0;font-family:"Playfair Display", serif;font-size:36px;letter-spacing:1.6px;font-weight:700}
  p.lead{color:var(--muted);margin-top:8px;line-height:1.45;max-width:760px}

  /* categories */
  .cats{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
    gap:12px;
    margin-top:18px;
  }
  .cat{
    height:110px;border-radius:8px;overflow:hidden;position:relative;cursor:pointer;
    display:flex;align-items:flex-end;padding:12px;background:#000;color:#ffffff;font-weight:700;
    background-size:cover;background-position:center;font-size:15px;
  }
  .cat::after{content:"";position:absolute;inset:0;background:linear-gradient(180deg,transparent,rgba(0,0,0,0.45))}

  /* product grid */
  .grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
    gap:16px;
    margin-top:22px;
  }
  .card{
    background:var(--card);border-radius:8px;overflow:hidden;border:1px solid #eee;padding:10px;
    display:flex;flex-direction:column;gap:10px;transition:transform .18s ease, box-shadow .18s ease;
  }
  .card:hover{transform:translateY(-6px);box-shadow:0 12px 30px rgba(0,0,0,0.06)}
  .thumb{height:220px;background-size:cover;background-position:center;border-radius:6px}
  .meta{display:flex;justify-content:space-between;align-items:center}
  .title{font-weight:600;font-size:15px}
  .price{font-weight:700}
  .desc{color:var(--muted);font-size:13px}

  .card-actions{display:flex;gap:8px}
  .btn{display:inline-block;padding:8px 10px;border-radius:6px;border:none;cursor:pointer;font-weight:700;font-size:13px}
  .btn-black{background:#000;color:#fff}
  .btn-ghost{background:transparent;border:1px solid #ddd;color:#111}

  /* product modal */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;padding:20px;background:rgba(0,0,0,0.45);z-index:90}
  .modal.open{display:flex}
  .modal-card{width:min(920px,95%);background:#fff;border-radius:10px;padding:20px;display:grid;grid-template-columns:1fr 1fr;gap:18px}
  .modal-img{height:420px;background-size:cover;background-position:center;border-radius:8px}
  .modal-info h2{font-family:"Playfair Display",serif;margin:0 0 8px 0}
  .modal-info p{color:var(--muted);line-height:1.5}
  .qty{display:flex;align-items:center;gap:8px;margin-top:14px}
  .qty button{padding:6px 10px;border-radius:6px;border:1px solid #ddd;background:#fff;cursor:pointer}

  /* CART PANEL (right) for desktop */
  .cart{
    padding:18px;border-left:1px solid #eee;background:linear-gradient(180deg,#fff,#fbfbfb);height:calc(100vh - var(--topbar-height) - 20px);position:sticky;top:calc(var(--topbar-height) + 10px);overflow:auto;
  }
  .cart h3{margin:0 0 12px 0;font-weight:700}
  .cart-items{max-height:56vh;overflow:auto;padding-right:8px}
  .cart-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px dashed #f0f0f0}
  .cart-row .name{font-size:14px}
  .cart-row .price{font-weight:700}
  .cart-foot{position:sticky;bottom:0;background:transparent;padding-top:12px;margin-top:10px}
  .checkout{width:100%;padding:12px;border-radius:8px;border:none;background:#000;color:#fff;font-weight:800;cursor:pointer}
  .whatsapp{margin-top:10px;text-align:center;font-size:13px;color:var(--muted)}

  /* BOTTOM CART (mobile) */
  .bottom-cart{
    display:none;
    position:fixed;left:12px;right:12px;bottom:12px;background:#fff;border-radius:12px;padding:12px;box-shadow:0 12px 30px rgba(0,0,0,0.12);z-index:80;
    align-items:center;justify-content:space-between;gap:12px;
  }
  .bottom-cart .mini{font-weight:700}

  /* toast */
  .toast{
    position:fixed;right:18px;bottom:92px;background:#111;color:#fff;padding:12px 16px;border-radius:8px;display:flex;gap:10px;align-items:center;
    box-shadow:0 12px 30px rgba(0,0,0,0.14);transform:translateY(10px);opacity:0;pointer-events:none;transition:all .28s ease;z-index:85;
  }
  .toast.show{opacity:1;transform:translateY(0);pointer-events:auto}

  /* responsive */
  @media (max-width: 980px){
    :root{--topbar-height:60px}
    .app{grid-template-columns:1fr; padding-top: calc(var(--topbar-height) + 12px)}
    .sidebar{display:none} /* hidden on mobile, opened via offcanvas */
    .cart{display:none}
    .modal-card{grid-template-columns:1fr;padding:16px}
    .thumb{height:260px}
    .hero-left h1{font-size:28px}
    .bottom-cart{display:flex}
    .hamburger{display:flex}
  }

  /* off-canvas sidebar (mobile) */
  .offcanvas{
    position:fixed;left:-320px;top:var(--topbar-height);bottom:0;width:300px;background:#fff;border-right:1px solid #eee;z-index:95;padding:18px;overflow:auto;transition:left .28s ease;
  }
  .offcanvas.open{left:0}
  .overlay{
    display:none;position:fixed;inset:0;background:rgba(0,0,0,0.35);z-index:90;
  }
  .overlay.show{display:block}

  /* helper */
  .muted{color:var(--muted)}
</style>
</head>
<body>

<!-- TOPBAR -->
<header class="topbar" role="banner">
  <div class="top-left">
    <button class="hamburger" id="menuToggle" aria-label="Open menu">
      â˜°
    </button>
    <div class="brand">Voyde de luxe</div>
  </div>

  <div class="top-right">
    <button class="icon-btn" id="cartToggle" aria-label="Open cart">
      ðŸ›’
      <span class="cart-count" id="cartCount" style="display:none">0</span>
    </button>
  </div>
</header>

<!-- offcanvas sidebar for mobile -->
<div class="offcanvas" id="offcanvas">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
    <div class="brand-side">Voyde de luxe</div>
    <button id="closeOff" style="background:transparent;border:0;font-size:20px;cursor:pointer">âœ•</button>
  </div>
  <nav>
    <ul class="side-list" id="mobileNav">
      <li><button data-cat="home" class="active">Home</button></li>
      <li><button data-cat="new">New Arrivals</button></li>
      <li><button data-cat="Tops">Tops</button></li>
      <li><button data-cat="Bottoms">Bottoms</button></li>
      <li><button data-cat="Ethnic Wear">Ethnic Wear</button></li>
      <li><button data-cat="Activewear">Activewear</button></li>
      <li><button data-cat="Intimates">Intimates</button></li>
      <li><button data-cat="Footwear">Footwear</button></li>
      <li><button data-cat="Perfumes">Perfumes</button></li>
      <li><button data-cat="about">About</button></li>
    </ul>
  </nav>
</div>
<div class="overlay" id="offOverlay"></div>

<div class="app" id="appRoot">

  <!-- DESKTOP SIDEBAR -->
  <aside class="sidebar" id="desktopSidebar">
    <div class="brand-side"></div>
    <nav>
      <ul class="side-list" id="navList">
        <li><button data-cat="home" class="active">Home</button></li>
        <li><button data-cat="new">New Arrivals</button></li>
        <li><button data-cat="Tops">Tops</button></li>
        <li><button data-cat="Bottoms">Bottoms</button></li>
        <li><button data-cat="Ethnic Wear">Ethnic Wear</button></li>
        <li><button data-cat="Activewear">Activewear</button></li>
        <li><button data-cat="Intimates">Intimates</button></li>
        <li><button data-cat="Footwear">Footwear</button></li>
        <li><button data-cat="Perfumes">Perfumes</button></li>
        <li><button data-cat="about">About</button></li>
      </ul>
    </nav>
  </aside>

  <!-- MAIN CONTENT -->
  <main id="mainContent" aria-live="polite">
    <div class="hero">
      <div class="hero-left">
        <h1>Curated Dresses & Essentials</h1>
        <p class="lead">A premium edit of dresses, elevated basics, and statement silhouettes â€” designed for clarity, comfort and flex. Click a category to explore.</p>
      </div>
      <div class="hero-right" style="align-self:flex-end">
      </div>
    </div>

    <!-- CATEGORIES (landing tiles) -->
    <section id="categories" class="cats" aria-label="Categories">
      <div class="cat" data-cat="Tops" style="background-image:url('https://images-cdn.ubuy.ae/660ca46a3ca7d70bac0d182a-htnbo-cute-crop-tops-for-women-summer.jpg')">Tops</div>
      <div class="cat" data-cat="Bottoms" style="background-image:url('https://img.kwcdn.com/product/fancy/71bf09e4-e7c8-4558-b367-b35ab55e9272.jpg?imageMogr2/auto-orient%7CimageView2/2/w/800/q/70/format/webp')">Bottoms</div>
      <div class="cat" data-cat="Ethnic Wear" style="background-image:url('https://www.lashkaraa.com/cdn/shop/articles/indian-outfits-women.jpg?v=1686585849&width=2048')">Ethnic Wear</div>
      <div class="cat" data-cat="Activewear" style="background-image:url('https://cdn.shopify.com/s/files/1/1468/3848/files/B6_7e93cf63-bbd6-42ce-97e3-0c00d7608a46_480x480.jpg?v=1732264849')">Active Wear</div>
      <div class="cat" data-cat="Intimates" style="background-image:url('https://lamourlingerie.com.au/cdn/shop/collections/533fc5de84977ac4090e5d57b435ded1--woman-pose-cotton-bralette.jpg?v=1668229270&width=1500')">Intimates</div>
      <div class="cat" data-cat="Footwear" style="background-image:url('https://5.imimg.com/data5/ANDROID/Default/2024/12/476928511/DR/PB/WZ/27306892/product-jpeg.jpg')">Footwear</div>
      <div class="cat" data-cat="Perfumes" style="background-image:url('https://hips.hearstapps.com/hmg-prod/images/img-3928-6810f244a05ad.jpg?crop=1.00xw:0.939xh;0,0.0466xh')">Perfume</div>
    </section>

    <!-- PRODUCTS GRID (dynamic) -->
    <section id="productsArea" aria-label="Products">
      <div class="grid" id="productGrid">
        <!-- Cards injected by JS -->
      </div>
    </section>
  </main>

  <!-- RIGHT CART PANEL (desktop) -->
  <aside class="cart" id="desktopCart">
    <h3>Cart</h3>
    <div class="cart-items" id="cartItems">
      <div style="color:#999">No items yet â€” add something fresh.</div>
    </div>

    <div class="cart-foot">
      <div style="display:flex;justify-content:space-between;margin:8px 0">
        <div class="small">Subtotal</div>
        <div id="cartTotal" style="font-weight:800">â‚¹0</div>
      </div>
      <button id="checkoutBtn" class="checkout">Checkout via WhatsApp</button>
      <div class="whatsapp">Orders go to: <strong>+91 8438623429</strong></div>
    </div>
  </aside>

</div>

<!-- BOTTOM CART (mobile) -->
<div class="bottom-cart" id="bottomCart">
  <div style="display:flex;flex-direction:column">
    <div class="mini" id="bottomCount">0 items</div>
    <div class="muted" id="bottomTotal">â‚¹0</div>
  </div>
  <button id="openBottomCart" class="checkout" style="padding:10px 14px">Open Cart</button>
</div>

<!-- PRODUCT MODAL -->
<div class="modal" id="productModal" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-modal="true">
    <div class="modal-left">
      <div id="modalImage" class="modal-img" style="background-image:url('')"></div>
    </div>
    <div class="modal-info">
      <h2 id="modalTitle">Title</h2>
      <div id="modalPrice" style="font-weight:800;margin-bottom:8px">â‚¹0</div>
      <p id="modalDesc" style="color:var(--muted)"></p>

      <div class="qty" style="margin-top:18px">
        <div style="display:flex;gap:8px;align-items:center">
          <button id="decQty">-</button>
          <div id="qtyVal" style="min-width:32px;text-align:center">1</div>
          <button id="incQty">+</button>
        </div>
        <div style="margin-left:12px;color:#666;font-size:13px">Size:
          <select id="selectSize" style="margin-left:8px;padding:6px;border-radius:6px;border:1px solid #eee">
            <option>S</option><option>M</option><option>L</option><option>XL</option>
          </select>
        </div>
      </div>

      <div style="margin-top:18px;display:flex;gap:10px" class="card-actions">
        <button id="modalAdd" class="btn btn-black">Add to Cart</button>
        <button id="modalEnquire" class="btn btn-ghost">Enquire on WhatsApp</button>
        <button id="modalClose" class="btn" style="background:transparent;border:0;color:#999">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- cart drawer for mobile -->
<div id="mobileCartDrawer" style="position:fixed;left:0;right:0;bottom:-100%;background:#fff;border-top-left-radius:12px;border-top-right-radius:12px;padding:16px;box-shadow:0 -12px 30px rgba(0,0,0,0.12);z-index:95;transition:bottom .28s ease;">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
    <div style="font-weight:800">Your Cart</div>
    <button id="closeMobileCart" style="background:transparent;border:0;cursor:pointer">Close</button>
  </div>
  <div id="mobileCartItems" style="max-height:50vh;overflow:auto;margin-bottom:8px"></div>
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><div class="small">Subtotal</div><div id="mobileCartTotal" style="font-weight:800">â‚¹0</div></div>
  <button id="mobileCheckout" class="checkout">Checkout via WhatsApp</button>
</div>

<!-- TOAST -->
<div class="toast" id="toast">
  <div id="toastMsg">Added to cart</div>
  <button id="undo" style="background:transparent;border:0;color:#ddd;cursor:pointer">Undo</button>
</div>

<script>
/* =========================
   Data model (sample items)
   ========================= */
const PRODUCTS = [
  { id: 't1', category:'Tops', title:'ZARA Midi Dress', price:6799, img:'https://static.zara.net/assets/public/800a/adbc/4db247a38160/f7bdb3c7ac61/08730111330-a2/08730111330-a2.jpg?ts=1754557813277', desc:'Sleek bias-cut midi with silk finish and refined silhouette.'},
  { id: 't2', category:'Tops', title:'Victoria Secret Slip', price:4599, img:'https://martiansonly.com/cdn/shop/products/image_8705c850-a8d5-43df-a99b-683564765176_1024x1024@2x.jpg?v=1658600778', desc:'Minimal satin slip â€” effortless evening piece.'},
  { id: 't3', category:'Tops', title:'Ralph Lauren Shirt', price:3999, img:'https://i.etsystatic.com/20677552/r/il/5ac41c/6777513520/il_300x300.6777513520_5to1.jpg', desc:'Tailored shirtdress with subtle structure.'},
  { id: 't4', category:'Tops', title:'Ralph Lauren Silk Cami', price:2199, img:'https://dtcralphlauren.scene7.com/is/image/PoloGSI/s7-AI290932473003_alternate10?$rl_4x5_pdp$', desc:'Delicate silk cami for day-to-night looks.'},
  { id: 't5', category:'Tops', title:'Cashmere Lounge Set', price:8999, img:'https://akamai-scene7.frontgate.com/is/image/frontgate/T_Template?$UPDP_Hero_SM$&$src=frontgate/147168_main', desc:'Ultra-soft cashmere knit set.'},
  { id: 'b1', category:'Bottoms', title:'Pepe women jeans', price:2999, img:'https://media-photos.depop.com/b0/18364824/896271783_3e62d2672c6641e085b150e25c524a6a/P0.jpg', desc:'Vintage Women jean for casual outs and Roadtrips'},
  { id: 'b2', category:'Bottoms', title:'Van Heusen trousers', price:3599, img:'https://rukminim2.flixcart.com/image/368/490/xif0q/trouser/a/5/t/38-lf-tr946-leriya-fashion-original-imahg3nguyhvag8z.jpeg?q=90&crop=false', desc:'Formal trousers for office, date night just to feel rich'},
  { id: 'b3', category:'Bottoms', title:'H&M cotton mini skirt', price:4679, img:'https://image.hm.com/assets/hm/e5/85/e58514a778efafe210bd019de737cfe044ba46ed.jpg?imwidth=2160', desc:' Gathered seam over the hips and gathered tiers with rolled edges for added volume.'},
  { id: 'd1', category:'Ethnic Wear', title:'Pernia Designer saree', price:75299, img:'https://img.perniaspopupshop.com/catalog/product/k/g/KGTC0424113_1.jpg?impolicy=listingimagenew', desc:' Accentuate with statement jewellery and heels for a wedding, sangeet or engagement ceremony.'},
  { id: 'd2', category:'Ethnic Wear', title:'Masaba Nan Khatai Lehenga', price:8999, img:'https://www.houseofmasaba.com/cdn/shop/files/Untitled-2-12.jpg?v=1724160151', desc:' Adorned in the Chand-phool motifs that hugs the bottom of the lehenga, with an ornate fully embroidered blouse, the beauty of this lehenga is realised through the creamy and dreamy hue.'},
  { id: 'a1', category:'Activewear', title:'Adidas Gym Wear', price:3499, img:'https://akns-images.eonline.com/eol_images/Entire_Site/20241130/rs_1200x1200-241230091035-new_year_workout_clothes_thumbnail.jpg?fit=around%7C1080:1080&output-quality=90&crop=1080:1080;center,top', desc:'Designed for hybrid training and versatile performance.'},
  { id: 'i1', category:'Intimates', title:'Victoria secret lingerie set', price:6455, img:'https://assets.myntassets.com/dpr_1.5,q_30,w_400,c_limit,fl_progressive/assets/images/2025/NOVEMBER/4/dcCb3UUm_61baee29f74b42a08dd04fc84662a073.jpg', desc:'Comfort without trading off richness'},
  { id: 'i2', category:'Intimates', title:'Calvin klein cotton sport innerwear', price:4399, img:'https://calvinklein-eu.scene7.com/is/image/CalvinKleinEU/0000F3787E_001_alternate2?$b2c_updp_m_mainImage_1920$', desc:'For high utilty feminine'},
  { id: 'i3', category:'Intimates', title:'Marks and spencer strapless top intimate', price:5879, img:'https://assets.digitalcontent.marksandspencer.app/image/upload/w_600,h_780,q_auto,f_auto,e_sharpen/SD_02_T33_2740_Z0_X_EC_0', desc:'Experience unrestrained movement'},
  { id: 'f1', category:'Footwear', title:'Yves Saint Laurent Heigh heels', price:134500, img:'https://femi9byas.com/cdn/shop/files/CF8361FC-0A20-484D-B160-1EB36D6EE2F7.jpg?v=1743531786', desc:'From the foremost fashion designers of the twentieth century'},
  { id: 'f2', category:'Footwear', title:'The Robin Attico High knee boots', price:64589, img:'https://www.net-a-porter.com/variants/images/1647597338932800/fr/w2000_q60.jpg', desc:'meant for bold yet comfortable eleganc'},
]

/* =========================
   App State
   ========================= */
let state = {
  filter: 'home',
  cart: [], // {id, title, price, qty, size}
  lastAdded: null
};

/* =========================
   Util
   ========================= */
const rupee = n => 'â‚¹' + Number(n).toLocaleString('en-IN');

/* =========================
   DOM refs
   ========================= */
const productGrid = document.getElementById('productGrid');
const navList = document.getElementById('navList');
const mobileNav = document.getElementById('mobileNav');
const categories = document.getElementById('categories');
const cartItemsEl = document.getElementById('cartItems');
const cartTotalEl = document.getElementById('cartTotal');
const checkoutBtn = document.getElementById('checkoutBtn');

const modal = document.getElementById('productModal');
const modalImage = document.getElementById('modalImage');
const modalTitle = document.getElementById('modalTitle');
const modalDesc = document.getElementById('modalDesc');
const modalPrice = document.getElementById('modalPrice');
const qtyVal = document.getElementById('qtyVal');
const decQty = document.getElementById('decQty');
const incQty = document.getElementById('incQty');
const modalAdd = document.getElementById('modalAdd');
const modalClose = document.getElementById('modalClose');
const modalEnquire = document.getElementById('modalEnquire');
const selectSize = document.getElementById('selectSize');

const toast = document.getElementById('toast');
const toastMsg = document.getElementById('toastMsg');
const undo = document.getElementById('undo');

const loader = document.getElementById('loader');
const menuToggle = document.getElementById('menuToggle');
const offcanvas = document.getElementById('offcanvas');
const offOverlay = document.getElementById('offOverlay');
const closeOff = document.getElementById('closeOff');

const cartToggle = document.getElementById('cartToggle');
const cartCount = document.getElementById('cartCount');
const bottomCart = document.getElementById('bottomCart');
const bottomCount = document.getElementById('bottomCount');
const bottomTotal = document.getElementById('bottomTotal');
const openBottomCart = document.getElementById('openBottomCart');
const mobileCartDrawer = document.getElementById('mobileCartDrawer');
const mobileCartItems = document.getElementById('mobileCartItems');
const mobileCartTotal = document.getElementById('mobileCartTotal');
const closeMobileCart = document.getElementById('closeMobileCart');
const mobileCheckout = document.getElementById('mobileCheckout');

let modalQty = 1;
let activeProduct = null;

/* =========================
   History / overlay stack
   ========================= */
let overlayStack = []; // tracks overlay names in order opened
// centralize close actions in the popstate handler
history.replaceState({ overlay: 'root' }, '', '');

/* helper to push overlay state */
function pushOverlay(name) {
  // push a state object with the overlay id, so back button can close it
  history.pushState({ overlay: name }, '', '');
  overlayStack.push(name);
}

/* =========================
   Render products
   ========================= */
function renderProducts() {
  productGrid.innerHTML = '';
  const filter = state.filter;
  const items = (filter === 'home' || filter === 'new') ? PRODUCTS.slice(0,8) : PRODUCTS.filter(p => p.category === filter);
  if(items.length === 0){
    productGrid.innerHTML = '<div style="color:#999;padding:20px">No items in this category yet.</div>';
    return;
  }
  items.forEach(p => {
    const card = document.createElement('article');
    card.className = 'card';
    card.innerHTML = `
      <div class="thumb" style="background-image:url('${p.img}')"></div>
      <div>
        <div class="meta"><div class="title">${p.title}</div><div class="price">${rupee(p.price)}</div></div>
        <div class="desc">${p.desc}</div>
        <div class="card-actions" style="margin-top:10px">
          <button class="btn btn-ghost view-btn" data-id="${p.id}">View</button>
          <button class="btn btn-black add-btn" data-id="${p.id}">Add</button>
        </div>
      </div>
    `;
    productGrid.appendChild(card);
  });
  // attach listeners
  document.querySelectorAll('.view-btn').forEach(b => b.addEventListener('click', e => openProductModal(e.target.dataset.id)));
  document.querySelectorAll('.add-btn').forEach(b => b.addEventListener('click', e => addToCartById(e.target.dataset.id,1,'M')));
}

/* =========================
   Nav & Category clicks (desktop)
   ========================= */
function activateNavButton(listRoot, clickedBtn){
  listRoot.querySelectorAll('button').forEach(x => x.classList.remove('active'));
  clickedBtn.classList.add('active');
}
navList.querySelectorAll('button').forEach(btn => {
  btn.addEventListener('click', () => {
    activateNavButton(navList, btn);
    const cat = btn.dataset.cat;
    state.filter = cat === 'home' ? 'home' : cat;
    renderProducts();
    setTimeout(()=> scrollToElement('#productGrid'), 30);
  });
});

/* mobile nav (offcanvas) */
mobileNav && mobileNav.querySelectorAll('button').forEach(btn => {
  btn.addEventListener('click', () => {
    activateNavButton(mobileNav, btn);
    const matchBtn = [...navList.querySelectorAll('button')].find(b => b.dataset.cat === btn.dataset.cat);
    if(matchBtn){
      activateNavButton(navList, matchBtn);
    }
    const cat = btn.dataset.cat;
    state.filter = cat === 'home' ? 'home' : cat;
    renderProducts();
    closeOffcanvasViaBack(); // close using history so popstate handles it
    setTimeout(()=> scrollToElement('#productGrid'), 30);
  });
});

/* categories tiles */
categories.querySelectorAll('.cat').forEach(tile => {
  tile.addEventListener('click', () => {
    const cat = tile.dataset.cat;
    const matchBtn = [...navList.querySelectorAll('button')].find(b => b.dataset.cat === cat);
    if(matchBtn) activateNavButton(navList, matchBtn);
    state.filter = cat;
    renderProducts();
    setTimeout(()=> scrollToElement('#productGrid'), 30);
  });
});

/* =========================
   Sidebar offcanvas controls (now use history)
   ========================= */
function openOffcanvas() {
  offcanvas.classList.add('open');
  offOverlay.classList.add('show');
  pushOverlay('offcanvas');
}
function closeOffcanvasImmediate() {
  offcanvas.classList.remove('open');
  offOverlay.classList.remove('show');
}
function closeOffcanvasViaBack() {
  // trigger history back so popstate will call the immediate close
  if (overlayStack[overlayStack.length - 1] === 'offcanvas') {
    history.back();
  } else {
    closeOffcanvasImmediate();
  }
}
menuToggle.addEventListener('click', () => {
  // open offcanvas and push history
  openOffcanvas();
});
closeOff.addEventListener('click', () => closeOffcanvasViaBack());
offOverlay.addEventListener('click', () => closeOffcanvasViaBack());

/* =========================
   Cart functions
   ========================= */
function addToCartById(id, qty=1, size='M'){
  const p = PRODUCTS.find(x=>x.id===id);
  if(!p) return;
  const existing = state.cart.find(i=>i.id===id && i.size===size);
  if(existing) existing.qty += qty;
  else state.cart.push({ id:p.id, title:p.title, price:p.price, qty, size });
  state.lastAdded = { id, qty };
  renderCart();
  showToast(`${p.title} added to cart`);
}

function renderCart(){
  // desktop
  cartItemsEl.innerHTML = '';
  if(state.cart.length===0){
    cartItemsEl.innerHTML = `<div style="color:#999">Your cart is empty.</div>`;
    cartTotalEl.textContent = rupee(0);
  } else {
    let total = 0;
    state.cart.forEach((it, idx) => {
      total += it.price * it.qty;
      const row = document.createElement('div');
      row.className = 'cart-row';
      row.innerHTML = `<div>
          <div class="name">${it.title} <div style="font-size:12px;color:#888">Size: ${it.size}</div></div>
        </div>
        <div style="text-align:right">
          <div class="price">${rupee(it.price * it.qty)}</div>
          <div style="margin-top:6px"><button data-idx="${idx}" class="btn" style="background:transparent;border:0;color:#888">Remove</button></div>
        </div>`;
      cartItemsEl.appendChild(row);
    });
    cartTotalEl.textContent = rupee(state.cart.reduce((a,b)=>a + b.price * b.qty,0));
    cartItemsEl.querySelectorAll('button').forEach(b => b.addEventListener('click', e => {
      const idx = Number(e.target.dataset.idx);
      state.cart.splice(idx,1);
      renderCart();
    }));
  }

  // mobile bottom cart
  const totalItems = state.cart.reduce((a,b)=>a + b.qty, 0);
  const totalAmount = state.cart.reduce((a,b)=>a + b.qty * b.price, 0);
  if(totalItems > 0){
    cartCount.style.display = 'inline-block';
    cartCount.textContent = totalItems;
    bottomCart.style.display = 'flex';
    bottomCount.textContent = `${totalItems} item${totalItems>1?'s':''}`;
    bottomTotal.textContent = rupee(totalAmount);
    document.getElementById('bottomCart').style.display = ''; // ensure visible
  } else {
    cartCount.style.display = 'none';
    bottomCart.style.display = 'none';
  }

  // mobile drawer content
  mobileCartItems.innerHTML = '';
  if(state.cart.length === 0){
    mobileCartItems.innerHTML = `<div style="color:#999">Cart is empty</div>`;
    mobileCartTotal.textContent = rupee(0);
  } else {
    state.cart.forEach((it, idx) => {
      const r = document.createElement('div');
      r.className = 'cart-row';
      r.style.borderBottom = '1px dashed #f0f0f0';
      r.style.padding = '8px 0';
      r.innerHTML = `<div style="max-width:70%"><div style="font-weight:700">${it.title}</div><div style="font-size:12px;color:#888">Size: ${it.size} Ã— ${it.qty}</div></div>
        <div style="text-align:right">${rupee(it.price * it.qty)}<div><button data-idx="${idx}" class="btn" style="background:transparent;border:0;color:#888">Remove</button></div></div>`;
      mobileCartItems.appendChild(r);
    });
    mobileCartTotal.textContent = rupee(state.cart.reduce((a,b)=>a + b.price * b.qty, 0));
    mobileCartItems.querySelectorAll('button').forEach(b => b.addEventListener('click', e => {
      const idx = Number(e.target.dataset.idx);
      state.cart.splice(idx,1);
      renderCart();
    }));
  }
}

/* =========================
   Modal (product showcase) + history integration
   ========================= */
function openProductModal(id){
  const p = PRODUCTS.find(x=>x.id===id);
  if(!p) return;
  activeProduct = p;
  modalImage.style.backgroundImage = `url('${p.img}')`;
  modalTitle.textContent = p.title;
  modalDesc.textContent = p.desc;
  modalPrice.textContent = rupee(p.price);
  modalQty = 1;
  qtyVal.textContent = modalQty;
  selectSize.value = 'M';
  modal.classList.add('open');
  modal.setAttribute('aria-hidden','false');
  pushOverlay('modal:' + p.id); // push overlay with product id so it's unique in stack
}
function closeModalImmediate(){
  modal.classList.remove('open'); modal.setAttribute('aria-hidden','true');
}
function closeModalViaBack(){
  if (overlayStack.length && overlayStack[overlayStack.length-1] && overlayStack[overlayStack.length-1].startsWith('modal:')) {
    history.back();
  } else {
    closeModalImmediate();
  }
}

modalClose.addEventListener('click', () => closeModalViaBack());
incQty.addEventListener('click', ()=>{ modalQty++; qtyVal.textContent = modalQty; });
decQty.addEventListener('click', ()=>{ if(modalQty>1) modalQty--; qtyVal.textContent = modalQty; });

modalAdd.addEventListener('click', () => {
  if(!activeProduct) return;
  addToCartById(activeProduct.id, modalQty, selectSize.value);
  closeModalViaBack();
});
modalEnquire.addEventListener('click', ()=> {
  if(!activeProduct) return;
  const msg = encodeURIComponent(`Hi, I want to enquire about *${activeProduct.title}* (Size: ${selectSize.value}).\n\nProduct: ${activeProduct.title}\nPrice: â‚¹${activeProduct.price}`);
  window.open(`https://wa.me/918438623429?text=${msg}`,'_blank');
});

/* =========================
   Toast (mini popup)
   ========================= */
let toastTimer = null;
function showToast(message){
  toastMsg.textContent = message;
  toast.classList.add('show');
  if(toastTimer) clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>{ toast.classList.remove('show'); }, 3000);
}
undo.addEventListener('click', ()=> {
  if(state.lastAdded){
    const idx = state.cart.findIndex(i => i.id === state.lastAdded.id);
    if(idx !== -1){
      if(state.cart[idx].qty > state.lastAdded.qty) state.cart[idx].qty -= state.lastAdded.qty;
      else state.cart.splice(idx,1);
      renderCart();
    }
  }
  toast.classList.remove('show');
});

/* =========================
   Checkout -> WhatsApp
   ========================= */
checkoutBtn.addEventListener('click', doCheckout);
mobileCheckout.addEventListener('click', doCheckout);
function doCheckout(){
  if(state.cart.length === 0){
    alert('Cart is empty â€” add an item first.');
    return;
  }
  let msg = `Hello, I want to place an order:%0A%0A`;
  state.cart.forEach((it, i) => {
    msg += `${i+1}. ${it.title} (Size: ${it.size}) Ã— ${it.qty} â€” â‚¹${it.price * it.qty}%0A`;
  });
  const total = state.cart.reduce((a,b)=>a + b.price * b.qty, 0);
  msg += `%0ATotal: â‚¹${total}%0A%0APlease confirm availability and next steps.`;
  window.open(`https://wa.me/918438623429?text=${msg}`, '_blank');
}

/* =========================
   Mobile cart drawer controls (history integrated)
   ========================= */
function openMobileCart() {
  mobileCartDrawer.style.bottom = '0';
  pushOverlay('mobileCart');
}
function closeMobileCartImmediate() {
  mobileCartDrawer.style.bottom = '-100%';
}
function closeMobileCartViaBack() {
  if (overlayStack[overlayStack.length - 1] === 'mobileCart') {
    history.back();
  } else {
    closeMobileCartImmediate();
  }
}

openBottomCart.addEventListener('click', () => {
  openMobileCart();
});
closeMobileCart.addEventListener('click', () => closeMobileCartViaBack());

cartToggle.addEventListener('click', ()=> {
  // show desktop cart if wide, else open mobile cart
  if(window.innerWidth > 980){
    // for desktop we just scroll to cart; no overlay push required
    document.getElementById('desktopCart').scrollIntoView({behavior:'smooth',block:'center'});
  } else {
    openMobileCart();
  }
});

/* =========================
   Offcanvas close on resize (clean) and update renders
   ========================= */
window.addEventListener('resize', ()=> {
  if(window.innerWidth > 980){
    // ensure mobile overlays are closed when switching to desktop viewport
    if (overlayStack.includes('offcanvas')) {
      // force-close without history (we're switching contexts)
      closeOffcanvasImmediate();
      overlayStack = overlayStack.filter(x => x !== 'offcanvas');
      history.replaceState({ overlay: 'root' }, '', ''); // reset history state to root
    }
    closeMobileCartImmediate();
  }
});

/* =========================
   util: scroll helper (accounts for topbar)
   ========================= */
function scrollToElement(selector){
  const el = document.querySelector(selector);
  if(!el) return;
  const topBarHeight = document.querySelector('.topbar').offsetHeight;
  const rect = el.getBoundingClientRect();
  const absoluteY = window.scrollY + rect.top;
  window.scrollTo({top: absoluteY - topBarHeight - 12, behavior:'smooth'});
}

/* =========================
   Keyboard: Esc closes modal and offcanvas (via history back)
   ========================= */
document.addEventListener('keydown', (e) => {
  if(e.key === 'Escape'){
    // prefer to trigger back so popstate cleans stack consistently
    if (overlayStack.length) {
      history.back();
    } else {
      // nothing open
      modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); closeOffcanvasImmediate(); closeMobileCartImmediate();
    }
  }
});

/* =========================
   popstate: central handler to close overlays in LIFO order
   ========================= */
window.addEventListener('popstate', (event) => {
  // if the overlay stack is empty or we returned to root -> ensure all overlays closed
  if (!overlayStack.length) {
    closeModalImmediate();
    closeOffcanvasImmediate();
    closeMobileCartImmediate();
    return;
  }

  // pop the last opened overlay and close it
  const last = overlayStack.pop();

  if (!last) return;

  if (last === 'offcanvas') {
    closeOffcanvasImmediate();
  } else if (last === 'mobileCart') {
    closeMobileCartImmediate();
  } else if (last.startsWith('modal:')) {
    closeModalImmediate();
  } else {
    // fallback: close everything
    closeModalImmediate();
    closeOffcanvasImmediate();
    closeMobileCartImmediate();
  }
});

/* =========================
   Accessibility & small helpers
   ========================= */
/* ensure clicking About nav scrolls to aboutSection */
const aboutBtn = [...document.querySelectorAll('[data-cat="about"]')];
aboutBtn.forEach(b => b.addEventListener('click', ()=> setTimeout(()=> scrollToElement('#aboutSection'), 60)));

/* Small improvement: auto-close offcanvas when product clicked on mobile */
document.body.addEventListener('click', (e) => {
  if(window.innerWidth <= 980 && offcanvas.classList.contains('open')){
    if(!offcanvas.contains(e.target) && !menuToggle.contains(e.target)) {
      // close via history for consistent UX
      closeOffcanvasViaBack();
    }
  }
});

/* Prevent focus outlines for mouse users but keep for keyboard users */
function handleFirstTab(e) {
  if (e.key === 'Tab') {
    document.body.classList.remove('using-mouse');
    window.removeEventListener('keydown', handleFirstTab);
  }
}
window.addEventListener('keydown', handleFirstTab);
document.body.classList.add('using-mouse');

/* small helper to close offcanvas after selecting category (already handled), but keep UX tight */
function closeOffcanvasImmediate(){ offcanvas.classList.remove('open'); offOverlay.classList.remove('show'); }

/* =========================
   Initial state: attach mobile nav to desktop nav (ensures parity)
   ========================= */
(function syncNavs(){
  const activeDesktop = navList.querySelector('button.active');
  if(activeDesktop && mobileNav){
    mobileNav.querySelectorAll('button').forEach(b => b.classList.remove('active'));
    const match = [...mobileNav.querySelectorAll('button')].find(x => x.dataset.cat === activeDesktop.dataset.cat);
    if(match) match.classList.add('active');
  }
})();

/* =========================
   Initial render + loader hide
   ========================= */
function init(){
  renderProducts();
  renderCart();
  // hide loader after a tiny delay so it looks smooth (simulate image loading)
  setTimeout(()=> {
    loader.style.display = 'none';
  }, 700);
}
window.addEventListener('load', init);

</script>
</body>
</html>
